import type { NextPage } from 'next';
import Head from 'next/head';
import { FormEvent, useEffect, useMemo, useState } from 'react';
import { useRecoilState } from 'recoil';
import { io } from 'socket.io-client';
import styled from 'styled-components';
import { v4 } from 'uuid';
import { userState } from '../atoms/user';
import { Message } from '../types/chat';

const socket = io(`http://localhost:8000`, {
  transports: ['websocket'],
});

const Home: NextPage = () => {
  const [chat, setChat] = useState('');
  const [chatList, setChatList] = useState<Message[]>([]);
  const userName = useMemo(() => v4(), []);
  const [user, setUser] = useRecoilState(userState);

  useEffect(() => {
    setUser({ name: userName });
  }, []);

  const handleChat = (e: FormEvent) => {
    e.preventDefault();
    socket.emit('chat message', {
      name: user.name,
      data: chat,
    });
    setChat('');
  };

  useEffect(() => {
    socket.on('send message', (message: Message) => {
      setChatList([...chatList, message]);
    });
  }, [chatList]);

  return (
    <>
      <Head>
        <title>Real time chatting</title>
        <meta name="description" content="Generated by create next app" />
        <link rel="icon" href="/favicon.ico" />
      </Head>

      <Container>
        <form onSubmit={handleChat}>
          <input
            type="text"
            value={chat}
            onChange={(e) => setChat(e.target.value)}
          />
          <button onClick={handleChat}> send </button>
        </form>

        <ChattingWrapper>
          {chatList.length > 0 &&
            chatList?.map((chat, index) => (
              <li key={chat.name + index}>
                {chat.name} : {chat.data}
              </li>
            ))}
        </ChattingWrapper>
      </Container>
      {/* 이전꺼 참고 */}
    </>
  );
};

const Container = styled.main`
  display: flex;
  flex-direction: column;
  justify-content: center;
  align-items: center;
`;

const ChattingWrapper = styled.div`
  width: 800px;
  height: 500px;
  background: tomato;
`;

export default Home;
